# 电池充电控制系统使用指南

## 功能说明

这个ESPHome配置实现了智能电池充电控制功能：
- 当电池电压 > 4.0V 时，自动停止充电
- 当电池电压 < 3.7V 时，自动开始充电
- 实时监测电池电压和充电状态
- 通过Home Assistant进行远程监控

## 硬件连接

### ESP8266 连接示例：
```
电池正极 ───┬─── 充电器正极
           │
           ├─── 分压电路 ─── A0 (电压监测)
           │
           └─── 负载设备

充电器控制 ─── D1 ─── 充电MOS管/继电器

电池负极 ─── GND ─── ESP8266 GND
```

### 分压电路（用于电压监测）：
```
电池正极 ───[ 10kΩ ]─────┬─── A0
                        │
                    [ 3.3kΩ ]
                        │
                       GND
```

## 重要配置参数

### 需要根据您的硬件调整的参数：

1. **分压系数** (在 `multiply` 滤波器中)：
   ```yaml
   filters:
     - multiply: 4.2  # 根据您的分压电路调整
   ```

2. **引脚配置**：
   ```yaml
   # 电压监测引脚
   pin: A0  # ESP8266: A0, ESP32: GPIO36等
   
   # 充电控制引脚
   pin: 
     number: D1  # ESP8266: D1-D8, ESP32: GPIO2等
   ```

3. **电压阈值**（如需要可在脚本中调整）：
   ```yaml
   if (voltage > 4.0 && charging) {  # 停止充电阈值
   else if (voltage < 3.7 && !charging) {  # 开始充电阈值
   ```

## 安全注意事项

1. **电压限制**：确保输入到ESP模拟引脚的电压不超过3.3V
2. **电流保护**：使用适当的保险丝或电流限制电路
3. **散热**：确保充电控制器件有足够的散热
4. **电池类型**：本配置适用于锂离子电池(3.7V标称电压)

## 使用步骤

1. **硬件连接**：按照上述电路图连接硬件
2. **配置修改**：
   - 修改WiFi SSID和密码
   - 调整引脚配置
   - 校准分压系数
3. **编译上传**：使用ESPHome编译并上传到设备
4. **Home Assistant集成**：设备会自动被Home Assistant发现

## 监控界面

在Home Assistant中，您将看到以下实体：
- `sensor.battery_voltage` - 实时电池电压
- `switch.charging_control` - 充电开关控制
- `binary_sensor.battery_charging` - 充电状态指示
- `text_sensor.battery_status` - 电池状态文本

## 故障排除

1. **电压读数不准确**：调整分压系数
2. **充电不启动**：检查充电控制引脚连接
3. **频繁开关充电**：可能需要增加迟滞电压或调整检查间隔
4. **设备离线**：检查WiFi配置和信号强度

## 进阶功能扩展

如果需要更复杂的功能，可以考虑添加：
- 充电电流监测
- 温度监测和保护
- 充电时间限制
- 多阶段充电算法
- 电池容量估算